name: main branch CI/CD

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:

  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
    - name: Deploy to Server via SSH action
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.HOST_USER }}
        key: ${{ secrets.SSH_PEM }}
        port: 22 
        env:
          ALGORITHM: "HS256"
          HOST_CONTAINER: "mysql-db-compose"
          USER_LOCAL: "admin"
          USER_CONTAINER: "admin"
          PASSWORD_LOCAL: "admin"
          PASSWORD_CONTAINER: "admin"
          DB_LOCAL: "Arosaje_db"
          DB_CONTAINER: "Arosaje_db"
          # PORT_LOCAL: "3306"
          PORT_CONTAINER: "3306"
          # REACT_APP_API_URL: ${{ secrets.REACT_APP_API_URL }}
          REACT_APP_API_URL: "http://ec2-13-37-248-200.eu-west-3.compute.amazonaws.com/" 
        run: |
          # Stop all running Docker Containers
          # if [ "$(docker ps -a -q)" ]; then
          #   docker kill $(docker ps -a -q)
          #   docker rm $(docker ps -a -q)
          # fi
          cd MSPR-BDD-B3/
          git pull
          sudo docker compose up -d --build
          echo "This is an environment variable: $HOST_LOCAL"
          echo "This is an environment variable: $SECRET"
          echo "This is an environment variable: $ALGORITHM"
          echo "This is an environment variable: $REACT_APP_API_URL"
          echo "This is an environment variable: $PORT_LOCAL"
