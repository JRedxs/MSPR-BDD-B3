name: main branch CI/CD

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

jobs:

  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      
    - name: Set environment variables
      run: |
        envBackPath="./MSPR-BDD-B3-Backend/back/src/.env"
        echo "DB_USERS=${{ secrets.DB_USERS }}" >> $envBackPath
        echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}" >> $envBackPath
        echo "DB_NAME=${{ secrets.DB_NAME }}" >> $envBackPath
        echo "ALGORITHM=${{ secrets.ALGORITHM }}" >> $envBackPath
        echo "SECRET_KEY=${{ secrets.SECRET_KEY }}" >> $envBackPath
        echo "HOST_LOCAL=${{ secrets.HOST_LOCAL }}" >> $envBackPath
        echo "HOST_CONTAINER=${{ secrets.HOST_CONTAINER }}" >> $envBackPath
        echo "USER_LOCAL=${{ secrets.USER_LOCAL }}" >> $envBackPath
        echo "USER_CONTAINER=${{ secrets.USER_CONTAINER }}" >> $envBackPath
        echo "PASSWORD_LOCAL=${{ secrets.PASSWORD_LOCAL }}" >> $envBackPath
        echo "PASSWORD_CONTAINER=${{ secrets.PASSWORD_CONTAINER }}" >> $envBackPath
        echo "DB_LOCAL=${{ secrets.DB_LOCAL }}" >> $envBackPath
        echo "DB_CONTAINER=${{ secrets.DB_LOCAL }}" >> $envBackPath
        echo "PORT_LOCAL=${{ secrets.PORT }}" >> $envBackPath
        echo "PORT_CONTAINER=${{ secrets.PORT }}" >> $envBackPath
      
    - name: Deploy to Server via SSH action
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.HOST_USER }}
        key: ${{ secrets.SSH_PEM }}
        port: 22 
        script: |
          # Stop all running Docker Containers
          # if [ "$(docker ps -a -q)" ]; then
          #   docker kill $(docker ps -a -q)
          #   docker rm $(docker ps -a -q)
          # fi
          cd MSPR-BDD-B3/
          git pull
          sudo docker compose up -d --build

  